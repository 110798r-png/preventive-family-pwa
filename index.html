<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>PREVENTIVE Family PWA ‚Äî Preview</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <!-- TailwindCSS —á–µ—Ä–µ–∑ CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />
    <style>
    html,
    body {
      width: 100%;
      max-width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    * {
      box-sizing: border-box;
    }
    img {
      max-width: 100%;
      display: block;
    }
    #root {
      width: 100%;
      height: 100%;
    }
    </style>
  </head>
  <body class="bg-slate-100">
    <div id="root"></div>

    <!-- React + ReactDOM + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- –í–µ—Å—å —Ç–≤–æ–π –∫–æ–¥ –≤ –≤–∏–¥–µ JSX —á–µ—Ä–µ–∑ Babel -->
    <script
      type="text/babel"
      data-presets="env,react"
      data-plugins="proposal-optional-chaining"
    >
      const { useEffect, useMemo, useRef, useState } = React;

      // –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –≤–º–µ—Å—Ç–æ framer-motion (–∞–Ω–∏–º–∞—Ü–∏–∏ –±—É–¥—É—Ç –æ–±—ã—á–Ω—ã–µ)
      const motion = {
        div: ({ children, ...rest }) => <div {...rest}>{children}</div>,
      };
      const AnimatePresence = ({ children }) => <>{children}</>;

      const STORAGE_KEY = "prev_family_pwa_light_v2";
      const DOCTOR_PIN = "2580";

      const LAB_CATS = [
        { id: "cbc", title: "–û–ê–ö", icon: "ü©∏" },
        { id: "uac", title: "–û–ê–ú", icon: "üß¥" },
        { id: "copro", title: "–ö–æ–ø—Ä–æ–≥—Ä–∞–º–º–∞", icon: "üß´" },
        { id: "biochem", title: "–ë–∏–æ—Ö–∏–º–∏—è", icon: "‚öóÔ∏è" },
        { id: "thyroid", title: "–©–∏—Ç–æ–≤–∏–¥–∫–∞", icon: "ü¶ã" },
        { id: "vit", title: "–í–∏—Ç–∞–º–∏–Ω—ã/–ú–∏–Ω.", icon: "üß©" },
        { id: "iron", title: "–ñ–µ–ª–µ–∑–æ", icon: "üß≤" },
        { id: "inf", title: "CMV/EBV", icon: "ü¶†" },
        { id: "us", title: "–£–ó–ò", icon: "üìü" },
        { id: "other", title: "–ü—Ä–æ—á–µ–µ", icon: "üìé" },
      ];

      function uid(prefix = "id") {
        return `${prefix}_${Math.random().toString(16).slice(2)}_${Math.random()
          .toString(16)
          .slice(2)}`;
      }

      function safeJsonParse(v) {
        try {
          return JSON.parse(v);
        } catch {
          return null;
        }
      }

      function ageFromDob(dob, now = new Date()) {
        if (!dob) return { years: 0, months: 0, totalMonths: 0 };
        const d = new Date(`${dob}T00:00:00`);
        let months =
          (now.getFullYear() - d.getFullYear()) * 12 +
          (now.getMonth() - d.getMonth());
        if (now.getDate() < d.getDate()) months -= 1;
        const totalMonths = Math.max(0, months);
        const years = Math.floor(totalMonths / 12);
        const rem = totalMonths % 12;
        return { years, months: rem, totalMonths };
      }

      function formTypeFor(dob, now = new Date()) {
        const a = ageFromDob(dob, now);
        if (a.totalMonths < 24) return "–î–µ—Ç–∏ –¥–æ 2 –ª–µ—Ç";
        if (a.years >= 7 && a.years < 18) return "–ü–æ–¥—Ä–æ—Å—Ç–∫–∏";
        if (a.years >= 18) return "–í–∑—Ä–æ—Å–ª—ã–µ";
        return "–î–µ—Ç–∏";
      }

      function fmtMemberMeta(m) {
        const a = ageFromDob(m.dob);
        const ageStr =
          a.totalMonths < 24
            ? `${a.years} –≥ ${a.months} –º–µ—Å`
            : `${a.years} –ª–µ—Ç`;
        return `${ageStr} ‚Ä¢ ${formTypeFor(m.dob)}`;
      }

      function ensureWorkflow(m) {
        const w = m.workflow || {};
        return {
          prepaymentType: w.prepaymentType || null,            // "urgent" | "prev" | null
          prepaymentStatus: w.prepaymentStatus || "none",      // "none" | "pending" | "confirmed"

          cardLink: w.cardLink || "",                          // —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –≤ Google –î–∏—Å–∫–µ
          cardLinkSentAt: w.cardLinkSentAt || null,

          anketaExternalDone: !!w.anketaExternalDone,          // –∞–Ω–∫–µ—Ç–∞ –≤ Google –î–∏—Å–∫–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
          anketaExternalDoneAt: w.anketaExternalDoneAt || null,

          appointmentDate: w.appointmentDate || "",            // –¥–∞—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∞)
          appointmentSetAt: w.appointmentSetAt || null,

          analysesList: w.analysesList || "",                  // —Ç–µ–∫—Å—Ç —Å–ø–∏—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ –æ—Ç –≤—Ä–∞—á–∞
          analysesListSentAt: w.analysesListSentAt || null,

          analysesUploaded: !!w.analysesUploaded,              // –ø–∞—Ü–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∏–ª –∞–Ω–∞–ª–∏–∑—ã
          analysesUploadedAt: w.analysesUploadedAt || null,

          treatmentReady: !!w.treatmentReady,                  // —Å—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è –≥–æ—Ç–æ–≤–∞
          treatmentReadyAt: w.treatmentReadyAt || null,
        };
      }

      function fmtDT(v) {
        const d = typeof v === "number" ? new Date(v) : new Date(v);
        return d.toLocaleString();
      }

      function defaultMember({ name, dob, sex, relation = "—è" }) {
        return {
          id: uid("m"),
          relation,
          name,
          dob,
          sex,
          anketa: null,
          chats: [
            {
              from: "doctor",
              text: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞–Ω–∞–ª–∏–∑—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.",
              ts: Date.now(),
            },
          ],
          labs: {},
          consult: { urgent: "none", prev: "none" },
          workflow: {
            prepaymentType: null,
            prepaymentStatus: "none",

            cardLink: "",
            cardLinkSentAt: null,

            anketaExternalDone: false,
            anketaExternalDoneAt: null,

            appointmentDate: "",
            appointmentSetAt: null,

            analysesList: "",
            analysesListSentAt: null,

            analysesUploaded: false,
            analysesUploadedAt: null,

            treatmentReady: false,
            treatmentReadyAt: null,
          },
        };
      }

      function makeDemoPatients() {
        const p1 = {
          id: "p1",
          name: "–ù–∏–∫–∏—Ç–∞ –ü—Ä–æ—Å–ª–∞–≤–µ–Ω–∫–æ",
          phone: "+79995550011",
          createdAt: new Date().toISOString(),
          members: [
            {
              ...defaultMember({
                name: "–ù–∏–∫–∏—Ç–∞ –ü—Ä–æ—Å–ª–∞–≤–µ–Ω–∫–æ",
                dob: "1996-03-10",
                sex: "m",
                relation: "—è",
              }),
              id: "m1",
            },
            {
              ...defaultMember({
                name: "–ê–Ω–Ω–∞ –ü—Ä–æ—Å–ª–∞–≤–µ–Ω–∫–æ",
                dob: "1998-11-02",
                sex: "f",
                relation: "–∂–µ–Ω–∞",
              }),
              id: "m2",
            },
            {
              ...defaultMember({
                name: "–ú–∞—Ä–∫ –ü—Ä–æ—Å–ª–∞–≤–µ–Ω–∫–æ",
                dob: "2021-08-18",
                sex: "m",
                relation: "—Ä–µ–±—ë–Ω–æ–∫",
              }),
              id: "m3",
            },
          ],
          selectedMemberId: "m1",
        };

        const p2 = {
          id: "p2",
          name: "–ê–º–∏–Ω–∞ –ê—Ö–º–µ–¥–æ–≤–∞",
          phone: "+79990000022",
          createdAt: new Date().toISOString(),
          members: [
            {
              ...defaultMember({
                name: "–ê–º–∏–Ω–∞ –ê—Ö–º–µ–¥–æ–≤–∞",
                dob: "2001-05-01",
                sex: "f",
                relation: "—è",
              }),
              id: "m21",
            },
            {
              ...defaultMember({
                name: "–ê–ª–∏",
                dob: "2024-02-14",
                sex: "m",
                relation: "—Ä–µ–±—ë–Ω–æ–∫",
              }),
              id: "m22",
            },
          ],
          selectedMemberId: "m21",
        };

        return [p1, p2];
      }

      function initialDoctorContent() {
        return {
          education:
            "‚Ä¢ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –≤—É–∑ / –ø–µ–¥–∏–∞—Ç—Ä–∏—è / —Ç–µ—Ä–∞–ø–∏—è\n" +
            "‚Ä¢ –ö—É—Ä—Å—ã –ø–æ –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω–µ –∏ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏–∏\n" +
            "‚Ä¢ –û–±—É—á–µ–Ω–∏–µ –ø–æ —Ä–∞–±–æ—Ç–µ —Å —Å–µ–º–µ–π–Ω—ã–º–∏ –∫–µ–π—Å–∞–º–∏",
          about:
            "–†–∞–±–æ—Ç–∞—é –±–µ–∑ –∑–∞–ø—É–≥–∏–≤–∞–Ω–∏—è, —Å —É–≤–∞–∂–µ–Ω–∏–µ–º –∫ –ø–∞—Ü–∏–µ–Ω—Ç—É. –í–µ–¥—É —Å–µ–º—å—é –∫–∞–∫ –æ–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç: —Å–æ–Ω, –ø–∏—Ç–∞–Ω–∏–µ, –∞–Ω–∞–ª–∏–∑—ã –∏ –ø—Ä–∏–≤—ã—á–∫–∏.",
          method:
            "1. –ö–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –ø–µ—Ä–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.\n" +
            "2. –ö–∞–∫–∏–µ –∞–Ω–∞–ª–∏–∑—ã –æ–±—ã—á–Ω–æ –Ω—É–∂–Ω—ã.\n" +
            "3. –ö–∞–∫ –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è.",
          guidesText: "–°–æ–Ω, –ü–∏—Ç–∞–Ω–∏–µ, –ö–∏—à–µ—á–Ω–∏–∫, –ì–æ—Ä–º–æ–Ω—ã, –î–µ—Ç–∏",
          stories: [
            {
              id: "st1",
              title: "–°–æ–Ω —Ä–µ–±—ë–Ω–∫–∞",
              text: "–ö–∞–∫ —Å–µ–º—å—è —É—à–ª–∞ –æ—Ç –Ω–æ—á–Ω—ã—Ö –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–π –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º—É —Å–Ω—É.",
            },
            {
              id: "st2",
              title: "–•—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–ª–æ—Å—Ç—å",
              text: "–ö–µ–π—Å, –≥–¥–µ –∞–Ω–∞–ª–∏–∑—ã –∏ —Ä–µ–∂–∏–º –¥–Ω—è –≤–µ—Ä–Ω—É–ª–∏ —ç–Ω–µ—Ä–≥–∏—é.",
            },
            {
              id: "st3",
              title: "–ö–∏—à–µ—á–Ω–∏–∫",
              text: "–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ –≤–∑–¥—É—Ç–∏–µ, –ø–∏—Ç–∞–Ω–∏–µ –∏ –º–∏–∫—Ä–æ–±–∏–æ—Ç—É.",
            },
          ],
        };
      }

      function initialState() {
        return {
          page: "home", // home | onboard | family | member | doctor
          memberTab: "overview", // overview | anketa | labs | chat | consult

          patients: makeDemoPatients(),
          activePatientId: "p1",
          doctorActivePatientId: "p1",

          paymentRequests: [],
          notifications: [],
          doctorContent: initialDoctorContent(),
        };
      }

      function loadState() {
        const base = initialState();
        if (typeof window === "undefined") return base;

        const raw = window.localStorage.getItem(STORAGE_KEY);
        const parsed = raw ? safeJsonParse(raw) : null;
        if (!parsed) return base;

        return {
          ...base,
          ...parsed,
          doctorContent: {
            ...base.doctorContent,
            ...(parsed.doctorContent || {}),
          },
        };
      }

      function saveState(s) {
        try {
          window.localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
        } catch {
          // ignore
        }
      }

      function Card({ children, className = "" }) {
        return (
          <div
            className={
              "rounded-3xl border border-black/10 bg-white shadow-[0_18px_60px_rgba(15,23,42,0.08)] " +
              className
            }
          >
            {children}
          </div>
        );
      }

      function Chip({ children, tone = "soft" }) {
        const cls =
          tone === "hard"
            ? "bg-slate-900 text-white border-slate-900"
            : "bg-slate-50 text-slate-700 border-black/10";
        return (
          <span
            className={
              "inline-flex items-center gap-1 px-3 py-1 rounded-full border text-xs " +
              cls
            }
          >
            {children}
          </span>
        );
      }

      function Btn({
        children,
        onClick,
        variant = "soft",
        className = "",
        disabled = false,
      }) {
        const base = "active:scale-[0.99] transition select-none";
        const v =
          variant === "solid"
            ? "bg-slate-900 text-white font-semibold hover:bg-slate-800"
            : variant === "ghost"
            ? "bg-transparent hover:bg-black/5"
            : "bg-black/5 hover:bg-black/10";
        return (
          <button
            disabled={disabled}
            onClick={onClick}
            className={
              base +
              " " +
              v +
              " rounded-2xl px-4 py-3 " +
              (disabled ? "opacity-50 " : "") +
              className
            }
          >
            {children}
          </button>
        );
      }

      function Modal({ open, title, subtitle, onClose, children, footer }) {
        return (
          <AnimatePresence>
            {open ? (
              <motion.div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/50" onClick={onClose} />
                <motion.div className="relative w-full max-w-[430px] rounded-[28px] border border-black/10 bg-white overflow-hidden shadow-[0_35px_120px_rgba(0,0,0,0.25)]">
                  <div className="p-4 border-b border-black/10 flex items-center justify-between">
                    <div>
                      <div className="font-semibold text-slate-900">{title}</div>
                      {subtitle ? (
                        <div className="text-xs text-slate-500 mt-0.5">
                          {subtitle}
                        </div>
                      ) : null}
                    </div>
                    <Btn
                      variant="soft"
                      onClick={onClose}
                      className="px-3 py-2"
                    >
                      ‚úï
                    </Btn>
                  </div>
                  <div className="p-4 max-h-[60vh] overflow-y-auto">{children}</div>
                  {footer ? (
                    <div className="p-4 border-t border-black/10">{footer}</div>
                  ) : null}
                </motion.div>
              </motion.div>
            ) : null}
          </AnimatePresence>
        );
      }

      function Toast({ msg }) {
        return (
          <AnimatePresence>
            {msg ? (
              <motion.div className="fixed left-1/2 -translate-x-1/2 bottom-6 z-[70] px-4">
                <div className="rounded-2xl border border-black/10 bg-white px-4 py-3 text-sm shadow-[0_18px_70px_rgba(15,23,42,0.18)] text-slate-900">
                  {msg}
                </div>
              </motion.div>
            ) : null}
          </AnimatePresence>
        );
      }

      function copyText(text, onOk) {
        try {
          navigator.clipboard?.writeText(text);
          onOk?.();
        } catch {
          // ignore
        }
      }

      function runSelfTests() {
        const NOW = new Date("2025-01-01T00:00:00Z");

        const t1 = formTypeFor("2024-02-01", NOW);
        if (t1 !== "–î–µ—Ç–∏ –¥–æ 2 –ª–µ—Ç")
          throw new Error(
            `Test failed: expected <–î–µ—Ç–∏ –¥–æ 2 –ª–µ—Ç>, got <${t1}>`
          );

        const t2 = formTypeFor("2015-01-02", NOW);
        if (t2 !== "–ü–æ–¥—Ä–æ—Å—Ç–∫–∏")
          throw new Error(
            `Test failed: expected <–ü–æ–¥—Ä–æ—Å—Ç–∫–∏>, got <${t2}>`
          );

        const t3 = formTypeFor("1990-01-02", NOW);
        if (t3 !== "–í–∑—Ä–æ—Å–ª—ã–µ")
          throw new Error(
            `Test failed: expected <–í–∑—Ä–æ—Å–ª—ã–µ>, got <${t3}>`
          );

        const u = uid("x");
        if (!u.startsWith("x_")) throw new Error("Test failed: uid prefix");

        const p = safeJsonParse('{"a":1}');
        if (!p || p.a !== 1)
          throw new Error("Test failed: safeJsonParse");
      }

      function PreventiveFamilyPWAPreviewLight() {
        const [s, setS] = useState(() =>
          typeof window === "undefined" ? initialState() : loadState()
        );
        const [toast, setToast] = useState("");

        const [addOpen, setAddOpen] = useState(false);
        const [anketaOpen, setAnketaOpen] = useState(false);
        const [doctorOpen, setDoctorOpen] = useState(false);

        const [oName, setOName] = useState("");
        const [oPhone, setOPhone] = useState("");

        const [mRelation, setMRelation] = useState("—Ä–µ–±—ë–Ω–æ–∫");
        const [mName, setMName] = useState("");
        const [mDob, setMDob] = useState("");
        const [mSex, setMSex] = useState("f");

        const [aGoal, setAGoal] = useState("");
        const [aComp, setAComp] = useState("");

        const [pin, setPin] = useState("");
        const [pinErr, setPinErr] = useState(false);

        const [openCat, setOpenCat] = useState(null);
        const [labDate, setLabDate] = useState("");
        const fileRef = useRef(null);

        const taps = useRef([]);

        useEffect(() => {
          try {
            runSelfTests();
            console.log("‚úÖ Self-tests passed");
          } catch (e) {
            console.error(e);
          }
        }, []);

        useEffect(() => {
          if (typeof window !== "undefined") saveState(s);
        }, [s]);

        useEffect(() => {
          if (!toast) return;
          const t = setTimeout(() => setToast(""), 1700);
          return () => clearTimeout(t);
        }, [toast]);

        const activePatient = useMemo(
          () => s.patients.find((p) => p.id === s.activePatientId) || s.patients[0],
          [s.patients, s.activePatientId]
        );

        const member = useMemo(() => {
          if (!activePatient) return null;
          return (
            activePatient.members.find(
              (m) => m.id === activePatient.selectedMemberId
            ) || activePatient.members[0]
          );
        }, [activePatient]);

        const unread = useMemo(
          () => s.notifications.filter((n) => n.unread).length,
          [s.notifications]
        );
        const consultActive =
          member?.consult?.urgent === "active" ||
          member?.consult?.prev === "active";

        const isDoctorContext =
          s.page === "member" &&
          s.doctorActivePatientId &&
          s.doctorActivePatientId === s.activePatientId;

        const doctorContent = s.doctorContent || initialDoctorContent();

        const onBrandTap = () => {
          const t = Date.now();
          taps.current = taps.current.filter((x) => t - x < 900);
          taps.current.push(t);
          if (taps.current.length >= 4) {
            taps.current = [];
            setPin("");
            setPinErr(false);
            setDoctorOpen(true);
          }
        };

        const reset = () => {
          try {
            window.localStorage.removeItem(STORAGE_KEY);
          } catch {
            // ignore
          }
          setS(initialState());
          setToast("–°–±—Ä–æ—à–µ–Ω–æ");
        };

        const go = (page) => setS((p) => ({ ...p, page }));

        const toggleProfileFromMenu = () => {
          setS((prev) => {
            let nextPage;
            if (prev.page === "home") {
              nextPage = "family";
            } else if (
              prev.page === "family" ||
              prev.page === "member" ||
              prev.page === "onboard"
            ) {
              nextPage = "home";
            } else {
              nextPage = "family";
            }
            return { ...prev, page: nextPage };
          });
        };

        const setTab = (memberTab) => setS((p) => ({ ...p, memberTab }));

        const finishOnboard = () => {
          const name = oName.trim();
          const phone = oPhone.trim();
          if (!name || !phone) {
            setToast("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω");
            return;
          }

          const patientId = uid("p");
          const patient = {
            id: patientId,
            name,
            phone,
            createdAt: new Date().toISOString(),
            members: [defaultMember({ name, dob: "1999-01-01", sex: "m", relation: "—è" })],
            selectedMemberId: null,
          };
          patient.selectedMemberId = patient.members[0].id;

          setS((prev) => ({
            ...prev,
            patients: [patient, ...prev.patients],
            activePatientId: patientId,
            doctorActivePatientId: patientId,
            page: "family",
            memberTab: "overview",
          }));

          setToast("–ü—Ä–æ—Ñ–∏–ª—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω");
        };

        const openAdd = () => {
          setMRelation("—Ä–µ–±—ë–Ω–æ–∫");
          setMName("");
          setMDob("");
          setMSex("f");
          setAddOpen(true);
        };

        const saveAdd = () => {
          if (!activePatient) return;
          if (!mName.trim() || !mDob) {
            setToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è");
            return;
          }

          const newM = {
            ...defaultMember({
              name: mName.trim(),
              dob: mDob,
              sex: mSex,
              relation: mRelation || "—á–ª–µ–Ω —Å–µ–º—å–∏",
            }),
            id: uid("m"),
          };

          setS((prev) => ({
            ...prev,
            patients: prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              return {
                ...p,
                members: [newM, ...p.members],
                selectedMemberId: newM.id,
              };
            }),
            page: "member",
            memberTab: "anketa",
          }));

          setAddOpen(false);
          setToast("–ß–ª–µ–Ω —Å–µ–º—å–∏ –¥–æ–±–∞–≤–ª–µ–Ω");
        };

        const selectMember = (memberId) => {
          setS((prev) => ({
            ...prev,
            patients: prev.patients.map((p) =>
              p.id === prev.activePatientId
                ? { ...p, selectedMemberId: memberId }
                : p
            ),
            page: "member",
            memberTab: "overview",
          }));
          setOpenCat(null);
        };

        const openAnketa = () => {
          if (!member) return;
          setAGoal(member?.anketa?.goal || "");
          setAComp(member?.anketa?.complaints || "");
          setAnketaOpen(true);
        };

        const saveAnketa = () => {
          setS((prev) => {
            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                return {
                  ...m,
                  anketa: {
                    goal: aGoal.trim(),
                    complaints: aComp.trim(),
                    updatedAt: new Date().toISOString(),
                  },
                  chats: [
                    ...(m.chats || []),
                    {
                      from: "patient",
                      text: "–Ø –∑–∞–ø–æ–ª–Ω–∏–ª(–∞) –∞–Ω–∫–µ—Ç—É ‚úÖ",
                      ts: Date.now(),
                    },
                    {
                      from: "doctor",
                      text: "–ü—Ä–∏–Ω—è–ª(–∞). –ú–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.",
                      ts: Date.now() + 250,
                    },
                  ],
                };
              });
              return { ...p, members };
            });
            return { ...prev, patients };
          });

          setAnketaOpen(false);
          setToast("–ê–Ω–∫–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
        };

        const chatSend = (text) => {
          const t = text.trim();
          if (!t) return;

          setS((prev) => {
            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                return {
                  ...m,
                  chats: [
                    ...(m.chats || []),
                    { from: "patient", text: t, ts: Date.now() },
                  ],
                };
              });
              return { ...p, members };
            });
            return { ...prev, patients };
          });

          setTimeout(() => {
            setS((prev) => {
              const patients = prev.patients.map((p) => {
                if (p.id !== prev.activePatientId) return p;
                const members = p.members.map((m) => {
                  if (m.id !== p.selectedMemberId) return m;
                  return {
                    ...m,
                    chats: [
                      ...(m.chats || []),
                      {
                        from: "doctor",
                        text: "–ü—Ä–∏–Ω—è–ª(–∞). –û—Ç–≤–µ—á—É –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è üëå",
                        ts: Date.now(),
                      },
                    ],
                  };
                });
                return { ...p, members };
              });
              return { ...prev, patients };
            });
          }, 380);
        };

        const addPayReq = (type) => {
          if (!activePatient || !member) return;

          setS((prev) => {
            const exists = prev.paymentRequests.find(
              (r) =>
                r.patientId === prev.activePatientId &&
                r.memberId === activePatient.selectedMemberId &&
                r.type === type &&
                r.status === "pending"
            );
            if (exists) {
              setToast("–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
              return prev;
            }

            const req = {
              id: uid("pay"),
              patientId: prev.activePatientId,
              memberId: activePatient.selectedMemberId,
              type,
              status: "pending",
              createdAt: new Date().toISOString(),
            };

            const notif = {
              id: uid("n"),
              title: "–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ—á–µ–Ω–∞",
              body: `${activePatient.name} (${activePatient.phone}): ${
                type === "urgent" ? "–°—Ä–æ—á–Ω–∞—è" : "–ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–∞—è"
              } ‚Äî ${member.name}`,
              createdAt: new Date().toISOString(),
              unread: true,
            };

            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                const consult = { ...(m.consult || {}) };
                const workflow = ensureWorkflow(m);

                if (type === "urgent") consult.urgent = "pending";
                else consult.prev = "pending";

                workflow.prepaymentType = type;
                workflow.prepaymentStatus = "pending";

                return {
                  ...m,
                  consult,
                  workflow,
                  chats: [
                    ...(m.chats || []),
                    {
                      from: "patient",
                      text: `–û—Ç–º–µ—Ç–∏–ª(–∞) –æ–ø–ª–∞—Ç—É: ${
                        type === "urgent" ? "–°—Ä–æ—á–Ω–∞—è" : "–ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–∞—è"
                      } ‚úÖ`,
                      ts: Date.now(),
                    },
                    {
                      from: "doctor",
                      text: "–û–∫. –ü—Ä–æ–≤–µ—Ä—é –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂—É.",
                      ts: Date.now() + 220,
                    },
                  ],
                };
              });
              return { ...p, members };
            });

            setToast("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Ä–∞—á—É");
            return {
              ...prev,
              paymentRequests: [req, ...prev.paymentRequests],
              notifications: [notif, ...prev.notifications],
              patients,
            };
          });
        };

        const confirmPay = (reqId, ok) => {
          setS((prev) => {
            const req = prev.paymentRequests.find((r) => r.id === reqId);
            if (!req || req.status !== "pending") return prev;

            const paymentRequests = prev.paymentRequests.map((r) =>
              r.id === reqId ? { ...r, status: ok ? "confirmed" : "rejected" } : r
            );

            const patients = prev.patients.map((p) => {
              if (p.id !== req.patientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== req.memberId) return m;
                const consult = { ...(m.consult || {}) };
                const workflow = ensureWorkflow(m);
                const label = req.type === "urgent" ? "–°—Ä–æ—á–Ω–∞—è" : "–ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–∞—è";

                if (ok) {
                  if (req.type === "urgent") consult.urgent = "active";
                  else consult.prev = "active";
                  workflow.prepaymentStatus = "confirmed";
                  workflow.prepaymentType = req.type;
                } else {
                  if (req.type === "urgent") consult.urgent = "none";
                  else consult.prev = "none";
                  workflow.prepaymentStatus = "none";
                  workflow.prepaymentType = null;
                }

                return {
                  ...m,
                  consult,
                  workflow,
                  chats: [
                    ...(m.chats || []),
                    {
                      from: "doctor",
                      text: ok
                        ? `–ü–æ–¥—Ç–≤–µ—Ä–¥–∏–ª(–∞) –æ–ø–ª–∞—Ç—É: ${label} ‚úÖ –î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç.`
                        : `–û–ø–ª–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ (${label}).`,
                      ts: Date.now(),
                    },
                  ],
                };
              });
              return { ...p, members };
            });

            setToast(ok ? "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ" : "–û—Ç–∫–ª–æ–Ω–µ–Ω–æ");
            return { ...prev, paymentRequests, patients };
          });
        };

        const openCatFiles = (catId) => {
          setOpenCat(catId);
          setLabDate("");
          if (fileRef.current) fileRef.current.value = "";
        };

        const addLabFile = () => {
          if (!activePatient || !member) return;
          if (!openCat) {
            setToast("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é");
            return;
          }
          const file = fileRef.current?.files?.[0];
          if (!file) {
            setToast("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
            return;
          }

          const rec = {
            id: uid("f"),
            fileName: file.name,
            size: file.size,
            mime: file.type,
            analysisDate: labDate || null,
            createdAt: new Date().toISOString(),
          };

          setS((prev) => {
            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                const labs = { ...(m.labs || {}) };
                labs[openCat] = labs[openCat] ? [rec, ...labs[openCat]] : [rec];
                const title = LAB_CATS.find((c) => c.id === openCat)?.title || "–ê–Ω–∞–ª–∏–∑";

                const workflow = ensureWorkflow(m);
                workflow.analysesUploaded = true;
                workflow.analysesUploadedAt = new Date().toISOString();

                return {
                  ...m,
                  labs,
                  workflow,
                  chats: [
                    ...(m.chats || []),
                    { from: "patient", text: `–ó–∞–≥—Ä—É–∑–∏–ª(–∞) –∞–Ω–∞–ª–∏–∑: ${title} ‚úÖ`, ts: Date.now() },
                  ],
                };
              });
              return { ...p, members };
            });
            return { ...prev, patients };
          });

          if (fileRef.current) fileRef.current.value = "";
          setLabDate("");
          setToast("–§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω");
        };

        const deleteLabFile = (catId, fileId) => {
          setS((prev) => {
            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                const labs = { ...(m.labs || {}) };
                labs[catId] = (labs[catId] || []).filter(
                  (x) => x.id !== fileId
                );
                return { ...m, labs };
              });
              return { ...p, members };
            });
            return { ...prev, patients };
          });
          setToast("–£–¥–∞–ª–µ–Ω–æ");
        };

        const markNotifRead = () => {
          if (!unread) {
            setToast("–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π");
            return;
          }
          setS((prev) => ({
            ...prev,
            notifications: prev.notifications.map((n) => ({
              ...n,
              unread: false,
            })),
          }));
          setToast("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω—ã");
        };

        const enterDoctor = () => {
          if (pin.trim() !== DOCTOR_PIN) {
            setPinErr(true);
            return;
          }

          setDoctorOpen(false);
          setPinErr(false);
          setS((prev) => ({
            ...prev,
            page: "doctor",
            notifications: prev.notifications.map((n) => ({
              ...n,
              unread: false,
            })),
          }));
          setToast("–í—Ö–æ–¥ –≤—Ä–∞—á–∞");
        };

        const patientMarkExternalAnketaDone = () => {
          if (!activePatient || !member) return;

          setS((prev) => {
            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                const workflow = ensureWorkflow(m);
                workflow.anketaExternalDone = true;
                workflow.anketaExternalDoneAt = new Date().toISOString();

                return {
                  ...m,
                  workflow,
                  chats: [
                    ...(m.chats || []),
                    {
                      from: "patient",
                      text: "–Ø –∑–∞–ø–æ–ª–Ω–∏–ª(–∞) –∞–Ω–∫–µ—Ç—É –≤ Google –î–∏—Å–∫–µ ‚úÖ",
                      ts: Date.now(),
                    },
                  ],
                };
              });
              return { ...p, members };
            });

            const notif = {
              id: uid("n"),
              title: "–ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞",
              body: `${activePatient.name} (${activePatient.phone}) ‚Ä¢ ${member.name}`,
              createdAt: new Date().toISOString(),
              unread: true,
            };

            return { ...prev, patients, notifications: [notif, ...prev.notifications] };
          });

          setToast("–û—Ç–º–µ—Ç–∏–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã");
        };

        const patientSetAppointmentDate = () => {
          if (!activePatient || !member) return;

          const current = member.workflow?.appointmentDate || "";
          const val = window.prompt(
            "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2025-02-01 14:00)",
            current
          );
          if (!val) return;

          setS((prev) => {
            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                const workflow = ensureWorkflow(m);
                workflow.appointmentDate = val;
                workflow.appointmentSetAt = new Date().toISOString();

                return {
                  ...m,
                  workflow,
                  chats: [
                    ...(m.chats || []),
                    {
                      from: "patient",
                      text: `–í—ã–±—Ä–∞–ª(–∞) –¥–∞—Ç—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: ${val}`,
                      ts: Date.now(),
                    },
                  ],
                };
              });
              return { ...p, members };
            });

            const notif = {
              id: uid("n"),
              title: "–í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏",
              body: `${activePatient.name} (${activePatient.phone}) ‚Ä¢ ${member.name} ‚Ä¢ ${val}`,
              createdAt: new Date().toISOString(),
              unread: true,
            };

            return { ...prev, patients, notifications: [notif, ...prev.notifications] };
          });

          setToast("–î–∞—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
        };

        const doctorSetCardLink = () => {
          if (!activePatient || !member) return;

          const current = member.workflow?.cardLink || "";
          const url = window.prompt(
            "–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –≤ Google –î–∏—Å–∫–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞",
            current
          );
          if (!url) return;

          setS((prev) => {
            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                const workflow = ensureWorkflow(m);
                workflow.cardLink = url;
                workflow.cardLinkSentAt = new Date().toISOString();

                return {
                  ...m,
                  workflow,
                  chats: [
                    ...(m.chats || []),
                    {
                      from: "doctor",
                      text: "–û—Ç–ø—Ä–∞–≤–∏–ª(–∞) —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à—É –∫–∞—Ä—Ç–æ—á–∫—É –≤ Google –î–∏—Å–∫–µ üîó",
                      ts: Date.now(),
                    },
                  ],
                };
              });
              return { ...p, members };
            });

            const notif = {
              id: uid("n"),
              title: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É",
              body: `${activePatient.name} (${activePatient.phone}) ‚Ä¢ ${member.name}`,
              createdAt: new Date().toISOString(),
              unread: true,
            };

            return { ...prev, patients, notifications: [notif, ...prev.notifications] };
          });

          setToast("–°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
        };

        const doctorSendAnalysesList = () => {
          if (!activePatient || !member) return;

          const current = member.workflow?.analysesList || "";
          const text = window.prompt(
            "–°–ø–∏—Å–æ–∫ –∞–Ω–∞–ª–∏–∑–æ–≤ –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)",
            current
          );
          if (!text || !text.trim()) return;

          setS((prev) => {
            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                const workflow = ensureWorkflow(m);
                workflow.analysesList = text.trim();
                workflow.analysesListSentAt = new Date().toISOString();

                return {
                  ...m,
                  workflow,
                  chats: [
                    ...(m.chats || []),
                    {
                      from: "doctor",
                      text: `–û—Ç–ø—Ä–∞–≤–∏–ª(–∞) —Å–ø–∏—Å–æ–∫ –∞–Ω–∞–ª–∏–∑–æ–≤:\n${text.trim()}`,
                      ts: Date.now(),
                    },
                  ],
                };
              });
              return { ...p, members };
            });

            const notif = {
              id: uid("n"),
              title: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –∞–Ω–∞–ª–∏–∑–æ–≤",
              body: `${activePatient.name} (${activePatient.phone}) ‚Ä¢ ${member.name}`,
              createdAt: new Date().toISOString(),
              unread: true,
            };

            return { ...prev, patients, notifications: [notif, ...prev.notifications] };
          });

          setToast("–°–ø–∏—Å–æ–∫ –∞–Ω–∞–ª–∏–∑–æ–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
        };

        const doctorMarkTreatmentReady = () => {
          if (!activePatient || !member) return;

          setS((prev) => {
            const patients = prev.patients.map((p) => {
              if (p.id !== prev.activePatientId) return p;
              const members = p.members.map((m) => {
                if (m.id !== p.selectedMemberId) return m;
                const workflow = ensureWorkflow(m);
                workflow.treatmentReady = true;
                workflow.treatmentReadyAt = new Date().toISOString();

                return {
                  ...m,
                  workflow,
                  chats: [
                    ...(m.chats || []),
                    {
                      from: "doctor",
                      text: "–°—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –≤ –≤–∞—à–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ –Ω–∞ Google –î–∏—Å–∫–µ ‚úÖ",
                      ts: Date.now(),
                    },
                  ],
                };
              });
              return { ...p, members };
            });

            const notif = {
              id: uid("n"),
              title: "–°—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è –≥–æ—Ç–æ–≤–∞",
              body: `${activePatient.name} (${activePatient.phone}) ‚Ä¢ ${member.name}`,
              createdAt: new Date().toISOString(),
              unread: true,
            };

            return { ...prev, patients, notifications: [notif, ...prev.notifications] };
          });

          setToast("–û—Ç–º–µ—Ç–∏–ª–∏, —á—Ç–æ —Å—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è –≥–æ—Ç–æ–≤–∞");
        };

        const updateDoctorContent = (patch) => {
          setS((prev) => {
            const base = prev.doctorContent || initialDoctorContent();
            return {
              ...prev,
              doctorContent: { ...base, ...patch },
            };
          });
        };

        const updateDoctorStory = (index, field, value) => {
          setS((prev) => {
            const base = prev.doctorContent || initialDoctorContent();
            const stories = (base.stories || []).map((st, i) =>
              i === index ? { ...st, [field]: value } : st
            );
            return {
              ...prev,
              doctorContent: { ...base, stories },
            };
          });
        };

        const pageVariants = {
          initial: { opacity: 0, y: 10 },
          animate: { opacity: 1, y: 0 },
          exit: { opacity: 0, y: 10 },
        };

        return (
          <div className="w-full h-screen flex justify-center bg-slate-100 overflow-hidden">
            <div className="w-full max-w-[430px] m-3 h-[calc(100vh-24px)] rounded-[32px] border border-black/10 bg-white overflow-hidden shadow-[0_35px_130px_rgba(15,23,42,0.22)] flex flex-col">
              {/* Topbar */}
              <div className="px-5 pt-5 pb-4 border-b border-black/10 bg-white">
                <div className="flex items-center justify-between">
                  <button
                    onClick={onBrandTap}
                    className="active:scale-[0.99] transition flex items-center gap-3 text-left"
                  >
                    <div className="w-11 h-11 rounded-2xl bg-slate-900 text-white flex items-center justify-center text-xl">
                      üß¨
                    </div>
                    <div>
                      <div className="font-semibold tracking-wide leading-tight text-slate-900">
                        PREVENTIVE
                      </div>
                      <div className="text-xs text-slate-500 -mt-0.5">
                        –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ ‚Ä¢ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                      </div>
                    </div>
                  </button>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={toggleProfileFromMenu}
                      className="active:scale-[0.99] transition rounded-2xl border border-black/10 bg-white px-3 py-2 text-xs text-slate-700"
                    >
                      ‚ò∞
                    </button>
                    <Btn
                      variant="soft"
                      className="text-xs px-3 py-2"
                      onClick={reset}
                    >
                      –°–±—Ä–æ—Å
                    </Btn>
                  </div>
                </div>

                <div className="mt-4 flex items-center justify-between">
                  <div>
                    <div className="text-sm text-slate-500">–ü–∞—Ü–∏–µ–Ω—Ç</div>
                    <div className="font-semibold text-slate-900">
                      {activePatient?.name || "‚Äî"}
                    </div>
                    <div className="text-xs text-slate-500">
                      {activePatient?.phone || ""}
                    </div>
                  </div>
                  <button
                    onClick={markNotifRead}
                    className={
                      "px-3 py-2 rounded-2xl border text-xs " +
                      (unread ? "bg-slate-50 " : "bg-white ") +
                      "border-black/10 text-slate-700"
                    }
                  >
                    üîî <b className="ml-1">{unread}</b>
                  </button>
                </div>
              </div>

              {/* Pages */}
              <div
                className="flex-1 overflow-y-auto"
                style={{
                  paddingBottom: "calc(92px + env(safe-area-inset-bottom))",
                }}
              >
                <AnimatePresence mode="wait">
                  {s.page === "home" ? (
                    <motion.div
                      key="home"
                      variants={pageVariants}
                      className="p-5 space-y-4"
                    >
                      <Card className="p-5">
                        <div className="flex items-start gap-4">
                          <div className="w-14 h-14 rounded-2xl bg-slate-900 text-white flex items-center justify-center text-2xl">
                            ü©∫
                          </div>
                          <div className="flex-1">
                            <div className="text-xs uppercase tracking-wide text-slate-500">
                              –í—Ä–∞—á –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã
                            </div>
                            <div className="text-lg font-semibold text-slate-900 mt-1">
                              –ò–º—è –§–∞–º–∏–ª–∏—è
                            </div>
                            <div className="text-sm text-slate-600 mt-1">
                              –†–∞–±–æ—Ç–∞—é —Å —Å–µ–º—å—è–º–∏: —Å–æ–Ω, –ø–∏—Ç–∞–Ω–∏–µ, –∞–Ω–∞–ª–∏–∑—ã –∏ –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏
                              –≤ –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ.
                            </div>
                            <Btn
                              variant="solid"
                              className="mt-4 text-sm w-full"
                              onClick={() => go("family")}
                            >
                              –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                            </Btn>
                          </div>
                        </div>
                      </Card>

                      <Card className="p-4">
                        <div className="font-semibold text-slate-900">
                          –ú–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
                        </div>
                        <div className="mt-2 text-sm text-slate-700 space-y-1">
                          {doctorContent.education
                            .split("\n")
                            .filter((line) => line.trim().length > 0)
                            .map((line, idx) => (
                              <div key={idx}>{line}</div>
                            ))}
                        </div>
                      </Card>

                      <Card className="p-4">
                        <div className="font-semibold text-slate-900">
                          –û —Å–µ–±–µ
                        </div>
                        <div className="mt-2 text-sm text-slate-700 whitespace-pre-wrap">
                          {doctorContent.about}
                        </div>
                      </Card>

                      <Card className="p-4">
                        <div className="font-semibold text-slate-900">
                          –ú–µ—Ç–æ–¥–∏—á–∫–∞
                        </div>
                        <div className="mt-2 text-sm text-slate-700 space-y-1">
                          {doctorContent.method
                            .split("\n")
                            .filter((line) => line.trim().length > 0)
                            .map((line, idx) => (
                              <div key={idx}>{line}</div>
                            ))}
                        </div>
                      </Card>

                      <Card className="p-4">
                        <div className="font-semibold text-slate-900">
                          –ì–∞–π–¥—ã
                        </div>
                        <div className="mt-2 flex flex-wrap gap-2 text-xs">
                          {doctorContent.guidesText
                            .split(",")
                            .map((g) => g.trim())
                            .filter((g) => g.length > 0)
                            .map((g, idx) => (
                              <Chip key={idx}>{g}</Chip>
                            ))}
                        </div>
                      </Card>

                      <Card className="p-4">
                        <div className="font-semibold text-slate-900 mb-2">
                          –ò—Å—Ç–æ—Ä–∏–∏
                        </div>
                        <div className="flex gap-3 overflow-x-auto pb-1">
                          {(doctorContent.stories || []).map((s, i) => (
                            <div
                              key={s.id || i}
                              className="min-w-[180px] max-w-[200px] rounded-2xl border border-black/10 bg-slate-50 p-3 text-xs text-slate-700"
                            >
                              {s.title ? (
                                <div className="font-semibold text-slate-900 mb-1">
                                  {s.title}
                                </div>
                              ) : null}
                              <div>{s.text}</div>
                            </div>
                          ))}
                        </div>
                      </Card>
                    </motion.div>
                  ) : null}

                  {s.page === "onboard" ? (
                    <motion.div
                      key="onboard"
                      variants={pageVariants}
                      className="p-5 space-y-4"
                    >
                      <Card className="p-5">
                        <div className="text-slate-900 font-semibold text-lg">
                          –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
                        </div>
                        <div className="mt-4 space-y-3">
                          <div>
                            <div className="text-xs text-slate-500">–ò–º—è</div>
                            <input
                              value={oName}
                              onChange={(e) => setOName(e.target.value)}
                              className="mt-1 w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∏–∫–∏—Ç–∞"
                            />
                          </div>
                          <div>
                            <div className="text-xs text-slate-500">
                              –¢–µ–ª–µ—Ñ–æ–Ω
                            </div>
                            <input
                              value={oPhone}
                              onChange={(e) => setOPhone(e.target.value)}
                              inputMode="tel"
                              className="mt-1 w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                              placeholder="+7‚Ä¶"
                            />
                          </div>
                          <Btn
                            variant="solid"
                            className="w-full"
                            onClick={finishOnboard}
                          >
                            –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                          </Btn>
                        </div>
                      </Card>

                      <Card className="p-4">
                        <div className="text-sm text-slate-700">
                          –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
                        </div>
                        <div className="mt-2 grid grid-cols-2 gap-2">
                          <Btn
                            variant="soft"
                            onClick={() => {
                              setS((prev) => ({
                                ...prev,
                                activePatientId: "p1",
                                page: "family",
                                memberTab: "overview",
                              }));
                              setToast("–û—Ç–∫—Ä—ã—Ç –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª—å");
                            }}
                          >
                            –û—Ç–∫—Ä—ã—Ç—å –¥–µ–º–æ
                          </Btn>
                          <Btn
                            variant="soft"
                            onClick={() => {
                              setOName("–ù–∏–∫–∏—Ç–∞ –ü—Ä–æ—Å–ª–∞–≤–µ–Ω–∫–æ");
                              setOPhone("+79995550011");
                            }}
                          >
                            –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä
                          </Btn>
                        </div>
                      </Card>
                    </motion.div>
                  ) : null}

                  {s.page === "family" && activePatient ? (
                    <motion.div
                      key="family"
                      variants={pageVariants}
                      className="p-5 space-y-4"
                    >
                      <Card className="p-4">
                        <div className="flex items-start justify-between gap-3">
                          <div>
                            <div className="text-lg font-semibold text-slate-900">
                              –ü—Ä–æ—Ñ–∏–ª—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
                            </div>
                            <div className="text-sm text-slate-600">
                              –í–Ω—É—Ç—Ä–∏ ‚Äî —á–ª–µ–Ω—ã —Å–µ–º—å–∏ –∏ –∏—Ö –∞–Ω–∫–µ—Ç—ã
                            </div>
                          </div>
                          <Btn
                            variant="solid"
                            className="text-sm"
                            onClick={openAdd}
                          >
                            + –î–æ–±–∞–≤–∏—Ç—å
                          </Btn>
                        </div>
                      </Card>

                      <div className="space-y-3">
                        {activePatient.members.map((m) => {
                          const labsCount = Object.values(
                            m.labs || {}
                          ).reduce(
                            (acc, arr) => acc + (arr?.length || 0),
                            0
                          );
                          const ank = m.anketa ? "–∑–∞–ø–æ–ª–Ω–µ–Ω–∞" : "–Ω–µ—Ç";
                          const cons =
                            m.consult?.urgent !== "none" ||
                            m.consult?.prev !== "none"
                              ? "–µ—Å—Ç—å"
                              : "–Ω–µ—Ç";
                          return (
                            <button
                              key={m.id}
                              onClick={() => selectMember(m.id)}
                              className="active:scale-[0.99] transition w-full text-left rounded-3xl border border-black/10 bg-white hover:bg-slate-50 p-4"
                            >
                              <div className="flex items-start justify-between gap-3">
                                <div>
                                  <div className="font-semibold text-lg leading-tight text-slate-900">
                                    {m.name}
                                    <span className="ml-2 text-xs text-slate-500">
                                      ({m.relation || "—á–ª–µ–Ω —Å–µ–º—å–∏"})
                                    </span>
                                  </div>
                                  <div className="text-sm text-slate-600 mt-0.5">
                                    {fmtMemberMeta(m)}
                                  </div>
                                </div>
                                <div className="text-right text-xs text-slate-600 space-y-2">
                                  <Chip>
                                    –ê–Ω–∫–µ—Ç–∞:{" "}
                                    <b className="ml-1">{ank}</b>
                                  </Chip>
                                  <div />
                                  <Chip>
                                    –§–∞–π–ª—ã:{" "}
                                    <b className="ml-1">{labsCount}</b>
                                  </Chip>
                                  <div />
                                  <Chip>
                                    –ö–æ–Ω—Å: <b className="ml-1">{cons}</b>
                                  </Chip>
                                </div>
                              </div>
                              <div className="mt-3 grid grid-cols-3 gap-2 text-sm text-slate-700">
                                <div className="rounded-2xl border border-black/10 bg-slate-50 py-2 text-center">
                                  –ê–Ω–∫–µ—Ç–∞
                                </div>
                                <div className="rounded-2xl border border-black/10 bg-slate-50 py-2 text-center">
                                  –ê–Ω–∞–ª–∏–∑—ã
                                </div>
                                <div className="rounded-2xl border border-black/10 bg-slate-50 py-2 text-center">
                                  –ß–∞—Ç
                                </div>
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    </motion.div>
                  ) : null}

                  {s.page === "member" && activePatient && member ? (
                    <motion.div
                      key="member"
                      variants={pageVariants}
                      className="p-5 space-y-4"
                    >
                      {/* —à–∞–ø–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–ª–µ–Ω–∞ —Å–µ–º—å–∏ */}
                      <div className="flex items-center justify-between">
                        <Btn
                          variant="soft"
                          className="text-sm px-3 py-2"
                          onClick={() => go("family")}
                        >
                          ‚Üê –ü—Ä–æ—Ñ–∏–ª—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
                        </Btn>
                        <div className="text-right">
                          <div className="font-semibold text-slate-900">
                            {member.name}
                          </div>
                          <div className="text-xs text-slate-600">
                            {member.relation ? member.relation + " ‚Ä¢ " : ""}
                            {fmtMemberMeta(member)}
                          </div>
                        </div>
                      </div>

                      {/* —Ç–∞–±—ã */}
                      <div className="flex gap-2 overflow-auto pb-1">
                        {[
                          { id: "overview", label: "–û–±–∑–æ—Ä" },
                          { id: "anketa", label: "–ê–Ω–∫–µ—Ç–∞" },
                          { id: "labs", label: "–ê–Ω–∞–ª–∏–∑—ã" },
                          { id: "chat", label: "–ß–∞—Ç" },
                          { id: "consult", label: "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏" },
                        ].map((t) => (
                          <Btn
                            key={t.id}
                            variant={
                              s.memberTab === t.id ? "solid" : "soft"
                            }
                            className="px-4 py-2 text-sm"
                            onClick={() => setTab(t.id)}
                          >
                            {t.label}
                          </Btn>
                        ))}
                      </div>

                      {/* –û–ë–ó–û–† */}
                      {s.memberTab === "overview" && (
                        <>
                          <Card className="p-4">
                            <div className="grid grid-cols-2 gap-3 text-sm">
                              <div className="rounded-2xl border border-black/10 bg-slate-50 p-3">
                                <div className="text-xs text-slate-500">–ê–Ω–∫–µ—Ç–∞</div>
                                <div className="mt-1 font-semibold text-slate-900">
                                  {member.anketa ? "–ó–∞–ø–æ–ª–Ω–µ–Ω–∞" : "–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞"}
                                </div>
                              </div>
                              <div className="rounded-2xl border border-black/10 bg-slate-50 p-3">
                                <div className="text-xs text-slate-500">–ê–Ω–∞–ª–∏–∑—ã</div>
                                <div className="mt-1 font-semibold text-slate-900">
                                  {Object.values(member.labs || {}).reduce(
                                    (acc, arr) => acc + (arr?.length || 0),
                                    0
                                  ) || "–ù–µ—Ç"}{" "}
                                  —Ñ–∞–π–ª(–æ–≤)
                                </div>
                              </div>
                              <div className="rounded-2xl border border-black/10 bg-slate-50 p-3">
                                <div className="text-xs text-slate-500">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</div>
                                <div className="mt-1 font-semibold text-slate-900">
                                  {[member.consult?.urgent, member.consult?.prev]
                                    .filter((x) => x && x !== "none")
                                    .join(" ‚Ä¢ ") || "–ù–µ—Ç"}
                                </div>
                              </div>
                              <div className="rounded-2xl border border-black/10 bg-slate-50 p-3">
                                <div className="text-xs text-slate-500">–¢–∏–ø –∞–Ω–∫–µ—Ç—ã</div>
                                <div className="mt-1 font-semibold text-slate-900">
                                  {formTypeFor(member.dob)}
                                </div>
                              </div>
                            </div>
                          </Card>

                          <Card className="p-4 mt-3">
                            <div className="font-semibold text-slate-900 mb-2">
                              –•–æ–¥ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
                            </div>
                            <div className="space-y-2 text-sm">
                              <div className="flex items-center justify-between">
                                <span>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</span>
                                <span className="text-slate-900">
                                  {member.workflow?.prepaymentStatus === "confirmed"
                                    ? "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞"
                                    : member.workflow?.prepaymentStatus === "pending"
                                    ? "–æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
                                    : "–Ω–µ –æ—Ç–º–µ—á–µ–Ω–∞"}
                                </span>
                              </div>

                              {member.workflow?.cardLink ? (
                                <div className="flex items-center justify-between gap-2">
                                  <span>–ö–∞—Ä—Ç–æ—á–∫–∞ –≤ Google –î–∏—Å–∫–µ</span>
                                  <a
                                    href={member.workflow.cardLink}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-xs text-sky-600 underline"
                                  >
                                    –û—Ç–∫—Ä—ã—Ç—å
                                  </a>
                                </div>
                              ) : (
                                <div className="text-xs text-slate-500">
                                  –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Ä–∞—á –µ—ë —Å–æ–∑–¥–∞—Å—Ç.
                                </div>
                              )}

                              <div className="flex items-center justify-between">
                                <span>–ê–Ω–∫–µ—Ç–∞ –≤ Google –î–∏—Å–∫–µ</span>
                                <span className="text-slate-900">
                                  {member.workflow?.anketaExternalDone
                                    ? "–∑–∞–ø–æ–ª–Ω–µ–Ω–∞"
                                    : "–æ–∂–∏–¥–∞–µ—Ç"}
                                </span>
                              </div>

                              <Btn
                                variant="soft"
                                className="w-full mt-1 text-xs"
                                onClick={patientMarkExternalAnketaDone}
                                disabled={!member.workflow?.cardLink}
                              >
                                –Ø –∑–∞–ø–æ–ª–Ω–∏–ª(–∞) –∞–Ω–∫–µ—Ç—É –≤ Google –î–∏—Å–∫–µ
                              </Btn>

                              <div className="flex items-center justify-between mt-2">
                                <span>–î–∞—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</span>
                                <span className="text-slate-900">
                                  {member.workflow?.appointmentDate || "–Ω–µ –≤—ã–±—Ä–∞–Ω–∞"}
                                </span>
                              </div>
                              <Btn
                                variant="soft"
                                className="w-full mt-1 text-xs"
                                onClick={patientSetAppointmentDate}
                              >
                                –í—ã–±—Ä–∞—Ç—å / –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É
                              </Btn>

                              {member.workflow?.analysesList ? (
                                <div className="mt-2 rounded-2xl border border-black/10 bg-slate-50 p-2 text-xs">
                                  <div className="text-slate-500 mb-1">
                                    –°–ø–∏—Å–æ–∫ –∞–Ω–∞–ª–∏–∑–æ–≤ –æ—Ç –≤—Ä–∞—á–∞:
                                  </div>
                                  <div className="text-slate-900 whitespace-pre-wrap">
                                    {member.workflow.analysesList}
                                  </div>
                                </div>
                              ) : (
                                <div className="mt-2 text-xs text-slate-500">
                                  –°–ø–∏—Å–æ–∫ –∞–Ω–∞–ª–∏–∑–æ–≤ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã –≤—Ä–∞—á–æ–º.
                                </div>
                              )}

                              <div className="flex items-center justify-between mt-2">
                                <span>–ê–Ω–∞–ª–∏–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã</span>
                                <span className="text-slate-900">
                                  {member.workflow?.analysesUploaded ? "–¥–∞" : "–µ—â—ë –Ω–µ—Ç"}
                                </span>
                              </div>

                              <div className="flex items-center justify-between mt-2">
                                <span>–°—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è</span>
                                <span className="text-slate-900">
                                  {member.workflow?.treatmentReady
                                    ? "–≥–æ—Ç–æ–≤–∞ (–≤ –∫–∞—Ä—Ç–æ—á–∫–µ –Ω–∞ –¥–∏—Å–∫–µ)"
                                    : "–µ—â—ë –≥–æ—Ç–æ–≤–∏—Ç—Å—è"}
                                </span>
                              </div>
                            </div>
                          </Card>
                        </>
                      )}

                      {/* –ê–ù–ö–ï–¢–ê */}
                      {s.memberTab === "anketa" && (
                        <Card className="p-4">
                          <div className="flex items-start justify-between gap-3">
                            <div>
                              <div className="font-semibold text-slate-900">
                                –ê–Ω–∫–µ—Ç–∞
                              </div>
                              <div className="text-sm text-slate-600 mt-1">
                                {member.anketa
                                  ? "–û–±–Ω–æ–≤–ª–µ–Ω–∞: " + fmtDT(member.anketa.updatedAt)
                                  : "–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞"}
                              </div>
                            </div>
                            <Btn
                              variant="solid"
                              className="text-sm"
                              onClick={openAnketa}
                            >
                              {member.anketa ? "–û–±–Ω–æ–≤–∏—Ç—å" : "–ó–∞–ø–æ–ª–Ω–∏—Ç—å"}
                            </Btn>
                          </div>

                          {member.anketa && (
                            <div className="mt-4 space-y-3">
                              <div className="rounded-2xl border border-black/10 bg-slate-50 p-3 text-sm">
                                <div className="text-xs text-slate-500">–¶–µ–ª—å</div>
                                <div className="mt-1 text-slate-900">
                                  {member.anketa.goal || "‚Äî"}
                                </div>
                              </div>
                              <div className="rounded-2xl border border-black/10 bg-slate-50 p-3 text-sm">
                                <div className="text-xs text-slate-500">–ñ–∞–ª–æ–±—ã</div>
                                <div className="mt-1 text-slate-900">
                                  {member.anketa.complaints || "‚Äî"}
                                </div>
                              </div>
                            </div>
                          )}
                        </Card>
                      )}

                      {/* –ê–ù–ê–õ–ò–ó–´ */}
                      {s.memberTab === "labs" && (
                        <Card className="p-4">
                          <div className="flex items-start justify-between gap-3">
                            <div>
                              <div className="font-semibold text-slate-900">
                                –ê–Ω–∞–ª–∏–∑—ã
                              </div>
                              <div className="text-sm text-slate-600 mt-1">
                                –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                              </div>
                            </div>
                          </div>

                          <div className="mt-4 grid grid-cols-2 gap-3">
                            {LAB_CATS.map((c) => {
                              const count = (member.labs?.[c.id] || []).length;
                              const status = count ? "–∑–∞–≥—Ä—É–∂–µ–Ω–æ" : "–ø—É—Å—Ç–æ";
                              const last = count
                                ? new Date(
                                    member.labs[c.id][0].createdAt
                                  ).toLocaleDateString()
                                : "‚Äî";
                              return (
                                <button
                                  key={c.id}
                                  onClick={() => openCatFiles(c.id)}
                                  className="active:scale-[0.99] transition rounded-3xl border border-black/10 bg-slate-50 hover:bg-slate-100 p-3 text-left"
                                >
                                  <div className="flex items-center justify-between">
                                    <div className="text-lg">{c.icon}</div>
                                    <Chip>{status}</Chip>
                                  </div>
                                  <div className="mt-2 font-semibold text-sm text-slate-900">
                                    {c.title}
                                  </div>
                                  <div className="text-xs text-slate-600 mt-1">
                                    –§–∞–π–ª—ã:{" "}
                                    <b className="text-slate-900">{count}</b>
                                  </div>
                                  <div className="text-[11px] text-slate-500 mt-1">
                                    –ø–æ—Å–ª–µ–¥–Ω–µ–µ: {last}
                                  </div>
                                </button>
                              );
                            })}
                          </div>

                          {openCat && (
                            <div className="mt-4 rounded-3xl border border-black/10 bg-white p-4">
                              <div className="flex items-center justify-between">
                                <div>
                                  <div className="font-semibold text-slate-900">
                                    {LAB_CATS.find((c) => c.id === openCat)?.icon}{" "}
                                    {LAB_CATS.find((c) => c.id === openCat)?.title}
                                  </div>
                                  <div className="text-xs text-slate-600">
                                    –§–∞–π–ª–æ–≤: {(member.labs?.[openCat] || []).length}
                                  </div>
                                </div>
                                <Btn
                                  variant="soft"
                                  className="text-sm px-3 py-2"
                                  onClick={() => setOpenCat(null)}
                                >
                                  –ó–∞–∫—Ä—ã—Ç—å
                                </Btn>
                              </div>

                              <div className="mt-3">
                                <div className="text-xs text-slate-500">
                                  –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                                </div>
                                <input
                                  value={labDate}
                                  onChange={(e) => setLabDate(e.target.value)}
                                  type="date"
                                  className="mt-1 w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                                />
                              </div>

                              <div className="mt-3">
                                <div className="text-xs text-slate-500">
                                  –§–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (PDF/–§–æ—Ç–æ)
                                </div>
                                <input
                                  ref={fileRef}
                                  type="file"
                                  accept="image/*,application/pdf"
                                  className="mt-2 w-full text-sm text-slate-700"
                                />
                                <Btn
                                  variant="solid"
                                  className="w-full mt-2"
                                  onClick={addLabFile}
                                >
                                  –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª
                                </Btn>
                              </div>

                              <div className="mt-4">
                                <div className="text-xs text-slate-500">–ò—Å—Ç–æ—Ä–∏—è</div>
                                <div className="mt-2 space-y-2">
                                  {(member.labs?.[openCat] || []).length === 0 ? (
                                    <div className="rounded-2xl border border-black/10 bg-slate-50 p-3 text-sm text-slate-600">
                                      –ü–æ–∫–∞ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤
                                    </div>
                                  ) : (
                                    (member.labs?.[openCat] || [])
                                      .slice()
                                      .sort((a, b) =>
                                        (b.createdAt || "")
                                          .toString()
                                          .localeCompare((a.createdAt || "").toString())
                                      )
                                      .map((f) => (
                                        <div
                                          key={f.id}
                                          className="rounded-2xl border border-black/10 bg-slate-50 p-3 text-sm"
                                        >
                                          <div className="flex items-start justify-between gap-3">
                                            <div>
                                              <div className="font-semibold text-slate-900">
                                                {f.fileName}
                                              </div>
                                              <div className="text-xs text-slate-600 mt-0.5">
                                                –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:{" "}
                                                {f.analysisDate
                                                  ? new Date(
                                                      f.analysisDate
                                                    ).toLocaleDateString()
                                                  : "‚Äî"}
                                              </div>
                                              <div className="text-[11px] text-slate-500 mt-0.5">
                                                –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {fmtDT(f.createdAt)}
                                              </div>
                                            </div>
                                            <Btn
                                              variant="soft"
                                              className="text-xs px-3 py-2"
                                              onClick={() =>
                                                deleteLabFile(openCat, f.id)
                                              }
                                            >
                                              –£–¥–∞–ª–∏—Ç—å
                                            </Btn>
                                          </div>
                                        </div>
                                      ))
                                  )}
                                </div>
                              </div>
                            </div>
                          )}
                        </Card>
                      )}

                      {/* –ß–ê–¢ */}
                      {s.memberTab === "chat" && (
                        <Card className="overflow-hidden">
                          <div className="p-4 border-b border-black/10 flex items-center justify-between">
                            <div>
                              <div className="font-semibold text-slate-900">
                                –ß–∞—Ç —Å –≤—Ä–∞—á–æ–º
                              </div>
                              <div className="text-xs text-slate-600">
                                –ü–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —á–ª–µ–Ω—É —Å–µ–º—å–∏
                              </div>
                            </div>
                            <Chip>
                              {consultActive ? "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞" : "–æ–±—ã—á–Ω—ã–π —á–∞—Ç"}
                            </Chip>
                          </div>
                          <div className="p-4 h-[320px] overflow-auto space-y-3 bg-white">
                            {(member.chats || []).map((msg, i) => {
                              const mine = msg.from === "patient";
                              return (
                                <div
                                  key={i}
                                  className={
                                    "flex " +
                                    (mine ? "justify-end" : "justify-start")
                                  }
                                >
                                  <div
                                    className={
                                      (mine
                                        ? "bg-slate-900 text-white"
                                        : "bg-slate-50 text-slate-900 border border-black/10") +
                                      " max-w-[80%] rounded-2xl px-4 py-3"
                                    }
                                  >
                                    <div className="text-[11px] opacity-70">
                                      {mine ? "–í—ã" : "–í—Ä–∞—á"} ‚Ä¢{" "}
                                      {new Date(msg.ts).toLocaleString()}
                                    </div>
                                    <div className="mt-1 text-sm leading-relaxed whitespace-pre-wrap">
                                      {msg.text}
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                          <ChatInput onSend={chatSend} />
                        </Card>
                      )}

                      {/* –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò */}
                      {s.memberTab === "consult" && (
                        <Card className="p-4">
                          <div className="font-semibold text-slate-900">
                            –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
                          </div>
                          <div className="text-sm text-slate-600 mt-1">
                            –û–ø–ª–∞—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–º ‚Üí –∑–∞—Ç–µ–º ¬´–û–ø–ª–∞—á–µ–Ω–æ¬ª
                          </div>

                          <div className="mt-4 space-y-3">
                            <div className="rounded-3xl border border-black/10 bg-slate-50 p-4">
                              <div className="flex items-start justify-between gap-3">
                                <div>
                                  <div className="font-semibold text-slate-900">
                                    üí¨ –°—Ä–æ—á–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
                                  </div>
                                  <div className="text-sm text-slate-600 mt-1">
                                    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
                                  </div>
                                </div>
                                <Chip>{member.consult?.urgent}</Chip>
                              </div>
                              <div className="mt-3 text-sm text-slate-700">
                                –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –Ω–æ–º–µ—Ä: <b>+7 (999) 000-00-00</b>
                              </div>
                              <div className="text-xs text-slate-600 mt-1">
                                –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:{" "}
                                <b>
                                  URGENT ‚Ä¢ {activePatient.phone} ‚Ä¢ {member.name}
                                </b>
                              </div>
                              <div className="mt-3 grid grid-cols-2 gap-2">
                                <Btn
                                  variant="soft"
                                  onClick={() =>
                                    copyText(
                                      `URGENT ‚Ä¢ ${activePatient.phone} ‚Ä¢ ${member.name}`,
                                      () => setToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ")
                                    )
                                  }
                                  className="text-sm"
                                >
                                  –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                </Btn>
                                <Btn
                                  variant="solid"
                                  onClick={() => addPayReq("urgent")}
                                  className="text-sm"
                                >
                                  –û–ø–ª–∞—á–µ–Ω–æ
                                </Btn>
                              </div>
                            </div>

                            <div className="rounded-3xl border border-black/10 bg-slate-50 p-4">
                              <div className="flex items-start justify-between gap-3">
                                <div>
                                  <div className="font-semibold text-slate-900">
                                    üß† –ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
                                  </div>
                                  <div className="text-sm text-slate-600 mt-1">
                                    –†–∞–∑–±–æ—Ä –∞–Ω–∫–µ—Ç—ã + –ø–ª–∞–Ω
                                  </div>
                                </div>
                                <Chip>{member.consult?.prev}</Chip>
                              </div>
                              <div className="mt-3 text-sm text-slate-700">
                                –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –Ω–æ–º–µ—Ä: <b>+7 (999) 000-00-00</b>
                              </div>
                              <div className="text-xs text-slate-600 mt-1">
                                –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:{" "}
                                <b>
                                  PREV ‚Ä¢ {activePatient.phone} ‚Ä¢ {member.name}
                                </b>
                              </div>
                              <div className="mt-3 grid grid-cols-2 gap-2">
                                <Btn
                                  variant="soft"
                                  onClick={() =>
                                    copyText(
                                      `PREV ‚Ä¢ ${activePatient.phone} ‚Ä¢ ${member.name}`,
                                      () => setToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ")
                                    )
                                  }
                                  className="text-sm"
                                >
                                  –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                </Btn>
                                <Btn
                                  variant="solid"
                                  onClick={() => addPayReq("prev")}
                                  className="text-sm"
                                >
                                  –û–ø–ª–∞—á–µ–Ω–æ
                                </Btn>
                              </div>
                            </div>
                          </div>
                        </Card>
                      )}

                      {/* –ë–õ–û–ö –î–ï–ô–°–¢–í–ò–ô –í–†–ê–ß–ê */}
                      {isDoctorContext && member && (
                        <DoctorMemberTools
                          member={member}
                          onSetCardLink={doctorSetCardLink}
                          onSendAnalyses={doctorSendAnalysesList}
                          onMarkTreatment={doctorMarkTreatmentReady}
                        />
                      )}
                    </motion.div>
                  ) : null}

                  {s.page === "doctor" ? (
                    <motion.div
                      key="doctor"
                      variants={pageVariants}
                      className="p-5 space-y-4"
                    >
                      <div className="flex items-center justify-between">
                        <Btn
                          variant="soft"
                          className="text-sm px-3 py-2"
                          onClick={() => go("family")}
                        >
                          ‚Üê –í—ã–π—Ç–∏
                        </Btn>
                        <div className="text-right">
                          <div className="font-semibold text-slate-900">
                            –ö–∞–±–∏–Ω–µ—Ç –≤—Ä–∞—á–∞
                          </div>
                          <div className="text-xs text-slate-600">
                            –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä + —Å–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
                          </div>
                        </div>
                      </div>

                      {/* –ö–û–ù–°–¢–†–£–ö–¢–û–† –ì–õ–ê–í–ù–û–ì–û –≠–ö–†–ê–ù–ê */}
                      <Card className="p-4">
                        <div className="font-semibold text-slate-900">
                          –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
                        </div>
                        <div className="text-xs text-slate-600 mt-1">
                          –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –±–ª–æ–∫–∏ ¬´–ú–æ—ë –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ¬ª, ¬´–û —Å–µ–±–µ¬ª, ¬´–ú–µ—Ç–æ–¥–∏—á–∫–∞¬ª, ¬´–ì–∞–π–¥—ã¬ª –∏ ¬´–ò—Å—Ç–æ—Ä–∏–∏¬ª ‚Äî —ç—Ç–æ —Ç–æ, —á—Ç–æ –≤–∏–¥–∏—Ç –ø–∞—Ü–∏–µ–Ω—Ç –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ.
                        </div>

                        <div className="mt-4 space-y-3 text-sm">
                          <div>
                            <div className="text-[11px] text-slate-500 mb-1">
                              –ú–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –ø—É–Ω–∫—Ç)
                            </div>
                            <textarea
                              value={doctorContent.education}
                              onChange={(e) =>
                                updateDoctorContent({ education: e.target.value })
                              }
                              rows={3}
                              className="w-full rounded-2xl bg-slate-50 border border-black/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black/10"
                            />
                          </div>

                          <div>
                            <div className="text-[11px] text-slate-500 mb-1">
                              –û —Å–µ–±–µ
                            </div>
                            <textarea
                              value={doctorContent.about}
                              onChange={(e) =>
                                updateDoctorContent({ about: e.target.value })
                              }
                              rows={3}
                              className="w-full rounded-2xl bg-slate-50 border border-black/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black/10"
                            />
                          </div>

                          <div>
                            <div className="text-[11px] text-slate-500 mb-1">
                              –ú–µ—Ç–æ–¥–∏—á–∫–∞ (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –ø—É–Ω–∫—Ç)
                            </div>
                            <textarea
                              value={doctorContent.method}
                              onChange={(e) =>
                                updateDoctorContent({ method: e.target.value })
                              }
                              rows={3}
                              className="w-full rounded-2xl bg-slate-50 border border-black/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black/10"
                            />
                          </div>

                          <div>
                            <div className="text-[11px] text-slate-500 mb-1">
                              –ì–∞–π–¥—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
                            </div>
                            <input
                              value={doctorContent.guidesText}
                              onChange={(e) =>
                                updateDoctorContent({ guidesText: e.target.value })
                              }
                              className="w-full rounded-2xl bg-slate-50 border border-black/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black/10"
                              placeholder="–°–æ–Ω, –ü–∏—Ç–∞–Ω–∏–µ, –ö–∏—à–µ—á–Ω–∏–∫‚Ä¶"
                            />
                          </div>

                          <div>
                            <div className="text-[11px] text-slate-500 mb-1">
                              –ò—Å—Ç–æ—Ä–∏–∏ (–¥–æ 3 —à—Ç—É–∫)
                            </div>
                            {(doctorContent.stories || []).map((story, idx) => (
                              <div
                                key={story.id || idx}
                                className="mt-2 rounded-2xl border border-black/10 bg-slate-50 p-3 space-y-2"
                              >
                                <input
                                  value={story.title}
                                  onChange={(e) =>
                                    updateDoctorStory(idx, "title", e.target.value)
                                  }
                                  className="w-full rounded-2xl bg-white border border-black/10 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-black/10"
                                  placeholder={`–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ ${idx + 1}`}
                                />
                                <textarea
                                  value={story.text}
                                  onChange={(e) =>
                                    updateDoctorStory(idx, "text", e.target.value)
                                  }
                                  rows={3}
                                  className="w-full rounded-2xl bg-white border border-black/10 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-black/10"
                                  placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –∫–µ–π—Å‚Ä¶"
                                />
                              </div>
                            ))}
                          </div>
                        </div>
                      </Card>

                      <Card className="p-4">
                        <div className="font-semibold text-slate-900">
                          –ü–∞—Ü–∏–µ–Ω—Ç—ã
                        </div>
                        <div className="mt-3 space-y-2">
                          {s.patients.map((p) => (
                            <button
                              key={p.id}
                              onClick={() =>
                                setS((prev) => ({
                                  ...prev,
                                  doctorActivePatientId: p.id,
                                }))
                              }
                              className={
                                "w-full text-left rounded-2xl border px-3 py-3 active:scale-[0.99] transition " +
                                (p.id === s.doctorActivePatientId
                                  ? "bg-slate-900 text-white border-slate-900"
                                  : "bg-white border-black/10 hover:bg-black/5 text-slate-900")
                              }
                            >
                              <div className="font-semibold">
                                {p.name}
                              </div>
                              <div
                                className={
                                  "text-xs " +
                                  (p.id === s.doctorActivePatientId
                                    ? "text-white/70"
                                    : "text-slate-600")
                                }
                              >
                                {p.phone}
                              </div>
                            </button>
                          ))}
                        </div>
                      </Card>

                      <Card className="p-4">
                        <div className="flex items-start justify-between gap-3">
                          <div>
                            <div className="font-semibold text-slate-900">
                              –ó–∞—è–≤–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É
                            </div>
                          </div>
                        </div>

                        <div className="mt-3 space-y-2">
                          {s.paymentRequests.filter(
                            (r) => r.status === "pending"
                          ).length === 0 ? (
                            <div className="rounded-2xl border border-black/10 bg-slate-50 p-3 text-sm text-slate-600">
                              –ù–µ—Ç –∑–∞—è–≤–æ–∫
                            </div>
                          ) : (
                            s.paymentRequests
                              .filter(
                                (r) => r.status === "pending"
                              )
                              .map((r) => {
                                const p = s.patients.find(
                                  (x) => x.id === r.patientId
                                );
                                const mm =
                                  p?.members?.find(
                                    (x) => x.id === r.memberId
                                  );
                                const label =
                                  r.type === "urgent"
                                    ? "–°—Ä–æ—á–Ω–∞—è"
                                    : "–ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–∞—è";
                                return (
                                  <div
                                    key={r.id}
                                    className="rounded-2xl border border-black/10 bg-slate-50 p-3 text-sm"
                                  >
                                    <div className="flex items-start justify-between gap-3">
                                      <div>
                                        <div className="font-semibold text-slate-900">
                                          {p?.name ||
                                            "–ü–∞—Ü–∏–µ–Ω—Ç"}{" "}
                                          ‚Ä¢ {label} ‚Ä¢{" "}
                                          {mm?.name || "‚Äî"}
                                        </div>
                                        <div className="text-xs text-slate-600 mt-0.5">
                                          {p?.phone || ""}
                                        </div>
                                        <div className="text-[11px] text-slate-500 mt-0.5">
                                          {fmtDT(
                                            r.createdAt
                                          )}
                                        </div>
                                      </div>
                                      <div className="flex flex-col gap-2">
                                        <Btn
                                          variant="solid"
                                          className="text-xs px-3 py-2"
                                          onClick={() =>
                                            confirmPay(
                                              r.id,
                                              true
                                            )
                                          }
                                        >
                                          –ü–æ–¥—Ç–≤.
                                        </Btn>
                                        <Btn
                                          variant="soft"
                                          className="text-xs px-3 py-2"
                                          onClick={() =>
                                            confirmPay(
                                              r.id,
                                              false
                                            )
                                          }
                                        >
                                          –û—Ç–∫–ª.
                                        </Btn>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })
                          )}
                        </div>
                      </Card>

                      <Card className="p-4">
                        <div className="font-semibold text-slate-900">
                          –°–µ–º—å—è –ø–∞—Ü–∏–µ–Ω—Ç–∞
                        </div>
                        <div className="mt-3 space-y-2">
                          {(
                            s.patients.find(
                              (p) =>
                                p.id === s.doctorActivePatientId
                            )?.members || []
                          ).map((m) => {
                            const labsCount = Object.values(
                              m.labs || {}
                            ).reduce(
                              (acc, arr) =>
                                acc + (arr?.length || 0),
                              0
                            );
                            const ank = m.anketa ? "–µ—Å—Ç—å" : "–Ω–µ—Ç";
                            return (
                              <button
                                key={m.id}
                                onClick={() => {
                                  setS((prev) => ({
                                    ...prev,
                                    activePatientId:
                                      prev.doctorActivePatientId,
                                    patients:
                                      prev.patients.map((pp) =>
                                        pp.id ===
                                        prev.doctorActivePatientId
                                          ? {
                                              ...pp,
                                              selectedMemberId:
                                                m.id,
                                            }
                                          : pp
                                      ),
                                    page: "member",
                                    memberTab: "labs",
                                  }));
                                  setOpenCat(null);
                                  setToast(
                                    "–û—Ç–∫—Ä—ã—Ç –ø—Ä–æ—Ñ–∏–ª—å —á–ª–µ–Ω–∞ —Å–µ–º—å–∏"
                                  );
                                }}
                                className="w-full text-left rounded-2xl border border-black/10 bg-white hover:bg-black/5 p-3 active:scale-[0.99] transition"
                              >
                                <div className="flex items-center justify-between gap-3">
                                  <div>
                                    <div className="font-semibold text-slate-900">
                                      {m.name}{" "}
                                      <span className="text-xs text-slate-500">
                                        (
                                        {m.relation ||
                                          "—á–ª–µ–Ω —Å–µ–º—å–∏"}
                                        )
                                      </span>
                                    </div>
                                    <div className="text-xs text-slate-600">
                                      {fmtMemberMeta(m)}
                                    </div>
                                  </div>
                                  <div className="text-right text-[11px] text-slate-600 space-y-2">
                                    <Chip>
                                      –ê–Ω–∫–µ—Ç–∞:{" "}
                                      <b className="ml-1">
                                        {ank}
                                      </b>
                                    </Chip>
                                    <div />
                                    <Chip>
                                      –§–∞–π–ª—ã:{" "}
                                      <b className="ml-1">
                                        {labsCount}
                                      </b>
                                    </Chip>
                                  </div>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      </Card>
                    </motion.div>
                  ) : null}
                </AnimatePresence>
              </div>

              {/* Bottom nav */}
              <div
                className="border-t border-black/10 bg-white px-3 py-3"
                style={{
                  paddingBottom: "env(safe-area-inset-bottom)",
                }}
              >
                <div className="grid grid-cols-3 gap-2">
                  <Btn
                    variant="soft"
                    className="text-sm"
                    onClick={() =>
                      go(
                        s.page === "home"
                          ? "family"
                          : s.page === "family" || s.page === "member"
                          ? "home"
                          : "family"
                      )
                    }
                  >
                    {s.page === "home" ? "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å" : "üè† –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω"}
                  </Btn>
                  <Btn
                    variant="soft"
                    className="text-sm"
                    onClick={() => go("member")}
                  >
                    üë™ –ß–ª–µ–Ω —Å–µ–º—å–∏
                  </Btn>
                  <Btn
                    variant="soft"
                    className="text-sm"
                    onClick={() =>
                      setToast("–î–ª—è –≤—Ö–æ–¥–∞ –≤—Ä–∞—á–∞: 4 —Ç–∞–ø–∞ –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É ‚Üí PIN 2580")
                    }
                  >
                    üõ°Ô∏è –í—Ä–∞—á
                  </Btn>
                </div>
              </div>

              {/* Modals */}
              <Modal
                open={addOpen}
                title="–î–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ —Å–µ–º—å–∏"
                subtitle="–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞"
                onClose={() => setAddOpen(false)}
                footer={
                  <Btn variant="solid" className="w-full" onClick={saveAdd}>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </Btn>
                }
              >
                <div className="space-y-3 text-sm">
                  <div>
                    <div className="text-xs text-slate-500">–ö—Ç–æ —ç—Ç–æ?</div>
                    <select
                      value={mRelation}
                      onChange={(e) => setMRelation(e.target.value)}
                      className="mt-1 w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                    >
                      <option value="—è">–Ø</option>
                      <option value="–∂–µ–Ω–∞">–ñ–µ–Ω–∞</option>
                      <option value="–º—É–∂">–ú—É–∂</option>
                      <option value="—Ä–µ–±—ë–Ω–æ–∫">–†–µ–±—ë–Ω–æ–∫</option>
                      <option value="–º–∞–º–∞">–ú–∞–º–∞</option>
                      <option value="–ø–∞–ø–∞">–ü–∞–ø–∞</option>
                      <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                    </select>
                  </div>
                  <div>
                    <div className="text-xs text-slate-500">–ò–º—è</div>
                    <input
                      value={mName}
                      onChange={(e) => setMName(e.target.value)}
                      className="mt-1 w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ä–∫"
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <div className="text-xs text-slate-500">
                        –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
                      </div>
                      <input
                        value={mDob}
                        onChange={(e) => setMDob(e.target.value)}
                        type="date"
                        className="mt-1 w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                      />
                    </div>
                    <div>
                      <div className="text-xs text-slate-500">–ü–æ–ª</div>
                      <select
                        value={mSex}
                        onChange={(e) => setMSex(e.target.value)}
                        className="mt-1 w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                      >
                        <option value="f">–ñ</option>
                        <option value="m">–ú</option>
                      </select>
                    </div>
                  </div>
                </div>
              </Modal>

              <Modal
                open={anketaOpen}
                title="–ê–Ω–∫–µ—Ç–∞ (–º–∏–Ω–∏)"
                subtitle={member ? `–¢–∏–ø: ${formTypeFor(member.dob)}` : ""}
                onClose={() => setAnketaOpen(false)}
                footer={
                  <Btn variant="solid" className="w-full" onClick={saveAnketa}>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </Btn>
                }
              >
                <div className="space-y-3 text-sm">
                  <div>
                    <div className="text-xs text-slate-500">–¶–µ–ª—å</div>
                    <textarea
                      value={aGoal}
                      onChange={(e) => setAGoal(e.target.value)}
                      rows={3}
                      className="mt-1 w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω, —É–±—Ä–∞—Ç—å –≤–∑–¥—É—Ç–∏–µ‚Ä¶"
                    />
                  </div>
                  <div>
                    <div className="text-xs text-slate-500">–ñ–∞–ª–æ–±—ã</div>
                    <textarea
                      value={aComp}
                      onChange={(e) => setAComp(e.target.value)}
                      rows={3}
                      className="mt-1 w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É—Å—Ç–∞–ª–æ—Å—Ç—å, –≤—ã—Å—ã–ø–∞–Ω–∏—è‚Ä¶"
                    />
                  </div>
                </div>
              </Modal>

              <Modal
                open={doctorOpen}
                title="–í—Ö–æ–¥ –≤—Ä–∞—á–∞"
                subtitle="–í–≤–µ–¥–∏—Ç–µ PIN"
                onClose={() => setDoctorOpen(false)}
                footer={
                  <Btn variant="solid" className="w-full" onClick={enterDoctor}>
                    –û–ö
                  </Btn>
                }
              >
                <div className="space-y-3">
                  <input
                    value={pin}
                    onChange={(e) => {
                      setPin(e.target.value);
                      setPinErr(false);
                    }}
                    type="password"
                    inputMode="numeric"
                    onKeyDown={(e) => {
                      if (e.key === "Enter") {
                        enterDoctor();
                      }
                    }}
                    className="w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10"
                    placeholder="PIN"
                  />
                  {pinErr ? (
                    <div className="text-xs text-red-600">
                      –ù–µ–≤–µ—Ä–Ω—ã–π PIN
                    </div>
                  ) : null}
                </div>
              </Modal>

              <Toast msg={toast} />
            </div>
          </div>
        );
      }

      function DoctorMemberTools({
        member,
        onSetCardLink,
        onSendAnalyses,
        onMarkTreatment,
      }) {
        const workflow = member.workflow || {};

        return (
          <div className="p-5 pt-0">
            <Card className="p-4">
              <div className="font-semibold text-slate-900">
                –î–µ–π—Å—Ç–≤–∏—è –≤—Ä–∞—á–∞ –ø–æ —ç—Ç–æ–º—É —á–ª–µ–Ω—É —Å–µ–º—å–∏
              </div>
              <div className="text-xs text-slate-600 mt-1">
                –≠—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –≤—Ä–∞—á–∞. –ü–∞—Ü–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å–≤–æ—ë–º –∫–∞–±–∏–Ω–µ—Ç–µ.
              </div>

              <div className="mt-3 space-y-2 text-sm">
                <Btn
                  variant="soft"
                  className="w-full text-xs"
                  onClick={onSetCardLink}
                >
                  –í—Å—Ç–∞–≤–∏—Ç—å / –æ–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É (Google –î–∏—Å–∫)
                </Btn>
                <Btn
                  variant="soft"
                  className="w-full text-xs"
                  onClick={onSendAnalyses}
                >
                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–Ω–∞–ª–∏–∑–æ–≤
                </Btn>
                <Btn
                  variant="soft"
                  className="w-full text-xs"
                  onClick={onMarkTreatment}
                >
                  –û—Ç–º–µ—Ç–∏—Ç—å: —Å—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è –≥–æ—Ç–æ–≤–∞
                </Btn>
              </div>

              {workflow.cardLink ? (
                <div className="mt-3 text-xs text-slate-600 break-all">
                  –¢–µ–∫—É—â–∞—è —Å—Å—ã–ª–∫–∞:{" "}
                  <a
                    href={workflow.cardLink}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-sky-600 underline"
                  >
                    {workflow.cardLink}
                  </a>
                </div>
              ) : null}

              {workflow.analysesList ? (
                <div className="mt-2 rounded-2xl border border-black/10 bg-slate-50 p-2 text-xs whitespace-pre-wrap">
                  {workflow.analysesList}
                </div>
              ) : null}
            </Card>
          </div>
        );
      }

      function ChatInput({ onSend }) {
        const [text, setText] = useState("");
        return (
          <div className="p-3 border-t border-black/10 flex gap-2 bg-white">
            <input
              value={text}
              onChange={(e) => setText(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === "Enter") {
                  onSend(text);
                  setText("");
                }
              }}
              className="w-full rounded-2xl bg-slate-50 border border-black/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-black/10 placeholder:text-slate-400"
              placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"
            />
            <button
              onClick={() => {
                onSend(text);
                setText("");
              }}
              className="active:scale-[0.99] transition rounded-2xl bg-slate-900 text-white font-semibold px-5 py-3"
            >
              ‚Üí
            </button>
          </div>
        );
      }

      const rootElement = document.getElementById("root");
      const root = ReactDOM.createRoot(rootElement);
      root.render(<PreventiveFamilyPWAPreviewLight />);
    </script>
  </body>
</html>
